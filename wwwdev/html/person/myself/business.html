<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>我的店铺</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="../../../js/common/flexible.js"></script>
		<link href="../../../css/lib/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../../css/app/app.css" />

		<style type="text/css">
			.box {
				display: flex;
				display: -webkit-flex;
				/* 新版本语法: Chrome 21+ */
				display: -webkit-box;
				/* 老版本语法: Safari, iOS, Android browser, older WebKit browsers. */
				align-content: center;
				justify-content: center;
			}
			
			.flex1 {
				-webkit-flex: 1;
				/* Chrome */
				flex: 1;
				/* NEW, Spec - Opera 12.1, Firefox 20+ */
				-webkit-box-flex: 1/* OLD - iOS 6-, Safari 3.1-6 */
				;
			}
		</style>

		<style type="text/css">
			body,
			.mui-content {
				background-color: #f5f5f9;
			}
			/*位置显示start*/
			
			.position {
				height: 1.04rem;
				/*margin-bottom: 0.266666rem;*/
				/*background-color: white;*/
			}
			
			.position>img {
				margin: 0.306666rem;
				width: 0.4rem;
				height: 0.4rem;
				vertical-align: middle;
			}
			/*位置显示end*/
			/*店铺详情start*/
			
			.shop_imgtext {
				height: 2.4rem;
			}
			
			.shop_image {
				width: 2.4rem;
				height: 2.4rem;
				margin-right: 0.346666rem;
				background-position: center;
				background-size: cover;
			}
			
			.shop_info {
				/*line-height: 0.426666rem;*/
				padding-right: 0.346666rem;
			}
			
			.shop_info>div {
				margin: 0.173333rem 0;
			}
			
			.distance {
				float: right;
			}
			
			.shop {
				padding: 0.346666rem 0 0 0.346666rem;
				background-color: white;
				margin-bottom: 0.266666rem;
			}
			
			.name {
				font-weight: bold;
				color: #2E2E2E;
			}
			
			.time>img {
				width: 0.4rem;
				height: 0.4rem;
				vertical-align: middle;
				margin-right: 0.32rem;
			}
			
			.time,
			.distance {
				color: #9F9FA0;
			}
			
			.activity {
				color: #F46276;
				/*color: #2BB8AA;*/
			}
			
			.address {
				padding: 0.4rem 0;
				padding-right: 0.4rem !important;
				color: #5D5C5C;
			}
			
			.shop_info {
				border-bottom: 1px solid #f5f5f5;
			}
			
			.shop_menu {
				color: #5D5C5C;
				padding-right: 0.346666rem;
				display: flex;
				display: -webkit-flex;
				/* 新版本语法: Chrome 21+ */
				display: -webkit-box;
				/* 老版本语法: Safari, iOS, Android browser, older WebKit browsers. */
				/*align-content: center;*/
				/*justify-content:  center;*/
				text-align: center;
			}
			
			.shop_menu>div>img {
				vertical-align: middle;
				margin: 0.346666rem 0.346666rem 0.346666rem 0;
				/*height: 0.373333rem;*/
				width: 0.373333rem;
			}
			/*店铺详情end*/
			
			.app-btn-main {
				height: 1.173333rem;
				width: 8.373333rem;
				margin: 1rem 0.813333rem;
			}
			
			
			.types {
				color: #2BB8AA;
				display: inline;
			}
		</style>
	</head>

	<body>
		<div class="root">

			<header class="mui-bar mui-bar-nav app-header">
				<a class="mui-action-back app-icon-back mui-pull-left"></a>
				<h1 class="mui-title">我的店铺</h1>
				<span @tap="onNewBtnTap()" class="mui-pull-right app-font-size-32 app-color-white" style="line-height: 45px;">新增</span>
			</header>

			<div class="mui-content wrapper mui-scroll-wrapper" ref='wrapper'>
				<div class="mui-scroll">

					<div>
						<template v-for="o,i in shops" :key="o.id">
							<div class="shop">
								<div class="shop_imgtext box">
									<div class="shop_image" :style='"background-image: url("+ _getImg(o.image1,o.image2,o.image3) +");"'>

									</div>
									<div class="shop_info flex1" @tap="onLookTap(o, i)">
										<!--<div class="distance app-font-size-28">{{_m2km(o.distance)}} km</div>-->
										<div class="name app-font-size-30 mui-ellipsis">{{o.name}}</div>
										<div class="types app-font-size-26">
											{{o.type}}
										</div>
										<!--<div class="activity app-font-size-26 mui-ellipsis">{{o.introduction}}</div>-->
									</div>
								</div>
								<div class="address app-font-size-28">
									<img src="" />
									<div class="mui-pull-left" style="width: 88%;">{{o.address}}</div>
									<div class="mui-pull-right" style="text-align: center;">
										<img src="../../../image/person/myself/icon_Collection@3x.png" style="width:0.45rem;" />
										<div class="app-font-size-22 app-color-9f9fa0" style="padding: 0;margin-top: -6px;">{{o.distance || 0}}</div>
									</div>
								</div>
								<br style="clear: both;" />
							</div>
						</template>
					</div>

				</div>
			</div>
			<!--<button @tap="onNewBtnTap()" type="button" class="mui-btn app-btn-main app-font-size-34">新建商铺</button>-->
		</div>
		<script type="text/javascript" src="../../../js/common/immersed.js"></script>

		<script type="text/javascript" src="../../../js/lib/vue.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/vue-ni.js"></script>

		<script src="../../../js/lib/mui.min.js"></script>

		<script type="text/javascript" src="../../../js/dal/base.js"></script>
		<script type="text/javascript" src="../../../js/dal/store.js"></script>
		
		<script type="text/javascript" src="../../../js/app/app-page.js" ></script>
		

		<script type="text/javascript">
			new Vue({
				el: ".root",
				data: function() {
					return {
						n: 0,

						shops: [],
					};
				},
				mounted: function() {

					this.$nextTick(function() {

						this.$pullRefresh = mui(".mui-scroll-wrapper");
						mui.init({
							pullRefresh: {
								container: ".mui-scroll-wrapper", //下拉刷新容器标识，querySelector能定位的css选择器均可，比如：id、.class等

								up: {
									auto: true,
									callback: this._up

								}
							}
						})
					}.bind(this));
				},
				plusReady: function() {
					var that = this;
					
					this.$view.setStyle({
						scrollIndicator: "none"
					});
					
					new ni.Broadcast().on('signup_success', function(data){
						//data.storeId
						// 更新
						that.shops = [];
						that._up();
					});

				},
				methods: {

					// 新建按钮
					onNewBtnTap: function() {
						mui.openWindow('../../nearby/business/signup.html', 'signup');
					},

					_getList: function(f) {
						dal.store.myList(this.n, function(err, data) {
							if(err) {
								return mui.toast(err.message);
							}

							f(data);
						});
					},

					// 点击查看
					onLookTap: function(o, index) {
						var that = this;
						app.page.openForResultBy("business_details.html", "business_details_edit", function(data){
							if(data && data.type === 0){
								// 删除
								that.shops.splice(index, 1);
							}
						}, {
							oid: o.id
						});
					},

					_up: function() {
						//this.n++;
						this._getList(function(data) {
							console.log(JSON.stringify(data));
							if(!data || !data.length) {
								this.$pullRefresh.pullRefresh().endPullupToRefresh();
							} else {
								this.shops.push.apply(this.shops, data);
							}
							this.$pullRefresh.pullRefresh().disablePullupToRefresh();

							//							if(!data || !data.length) {
							//								mui.toast('没有更多啦~~');
							//								this.$pullRefresh.pullRefresh().endPullupToRefresh();
							//							} else {
							//								this.shops.push.apply(this.shops, data);
							//							}
							//							this.$pullRefresh.pullRefresh().endPullupToRefresh(); 
						}.bind(this));
					},
					_min2time: function(n) {
						n = +n
						return(n < 10 ? '0' : '') + parseInt(n) + ':' + ((n % 1 * 60) === 0 ? '00' : '30');
					},
					_m2km: function(m) {
						return(m / 1000).toFixed(1);
					},
					_getImg: function(img1, img2, img3) {
						return img1 || img2 || img3;
					},
				}

			});
		</script>
	</body>

</html>