<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>发布说说</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="../../../js/common/flexible.js"></script>
		<link href="../../../css/lib/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../../css/app/app.css" />

		<style type="text/css">
			html,
			body,
			.mui-content {
				background-color: #f5f5f9;
			}
			
			.tips2 {
				padding: 0 0.346666rem;
				background-color: #FFFFFF;
				color: #333333;
				position: relative;
				height: 1.2rem;
				line-height: 1.2rem;
			}
			
			.tips2:after {
				content: "";
				position: absolute;
				height: 1px;
				width: 9.306666rem;
				left: 0.346666rem;
				bottom: 0;
				background-color: #f5f5f5;
				transform: scaleY(0.5);
				-webkit-transform: scaleY(0.5);
			}
			
			.imgRoom {
				background-color: #FFFFFF;
				padding: 0.346666rem;
				display: flex;
				display: -webkit-flex;
				justify-content: space-between;
				flex-wrap: wrap;
			}
			
			.imgRoom>div {
				width: 2.88rem;
				height: 2.88rem;
				background-color: #F4F8FB;
				margin: 0.173333rem 0;
				background-size: cover;
				background-position: center;
			}
			
			.imgRoom>div {
				pointer-events: none;
			}
			
			.imgRoom>div.last,
			.imgRoom>div.over {
				pointer-events: all;
				position: relative;
			}
			
			.imgRoom>div.last:after {
				content: '';
				z-index: 20;
				position: absolute;
				background-image: url(../../../image/nearby/business/add_icon.png);
				background-size: cover;
				background-position: center;
				height: 0.666666rem;
				width: 0.666666rem;
				left: 50%;
				top: 50%;
				transform: translate(-50%, -50%);
				-webkit-transform: translate(-50%, -50%);
			}
			
			textarea {
				border: none;
				padding: 0;
				margin-bottom: 0.346666rem;
				font-size: 13px;
				height: 2.5rem;
			}
			
			textarea::-webkit-input-placeholder,
			input::-webkit-input-placeholder {
				font-size: 13px;
				color: #A2A6B1;
			}
			
			input {
				border: 0px !important;
				width: 7rem !important;
				padding: 0;
				/*height: 0.453333rem !important;*/
				margin-bottom: 0 !important;
			}
			
			.room {
				padding: 0.346666rem;
				background-color: #FFFFFF;
				position: relative;
				margin-bottom: 0.266666rem;
			}
			
			.room:after {
				position: absolute;
				content: attr(data-ts);
				color: #a2a6b1;
				right: 0.346666rem;
				bottom: 0.346666rem;
			}
			
			.room.ps:after {
				content: '';
				left: 0.413333rem;
				top: 0;
				height: 1px;
				background-color: #f5f5f5;
				transform: scaleY(0.5);
				-webkit-transform: scaleY(0.5);
			}
			
			.ps {
				display: flex;
				display: -webkit-flex;
				align-items: center;
				color: #9F9FA0;
				margin-bottom: 0;
			}
			
			.ps>img {
				margin-right: 0.15rem;
			}
			
			.tips {
				margin: 0 0 0.16rem 0;
			}
			
			.color808080 {
				color: #808080;
			}
			
			.cardRoom {
				display: flex;
				display: -webkit-flex;
				align-content: center;
				justify-content: flex-start;
				flex-flow: wrap row;
			}
			
			.cardRoom>div:active {
				background-color: #F5F5F5;
			}
			
			.cardRoom>div {
				text-align: center;
				width: 1.733333rem;
				height: 0.666666rem;
				margin: 0 .16rem .16rem 0;
				border-radius: 5px;
				background-color: #e5e6e7;
				line-height: 0.666666rem;
			}
			
			.cardRoom>div>* {
				vertical-align: middle;
			}
			
			.cityRoom {
				padding-left: .4rem;
				background-color: #FFFFFF;
			}
			
			button {
				margin: 2.293333rem 0.346666rem 0.693333rem 0.346666rem;
				width: 9.306666rem;
				height: 1.186666rem;
			}
		</style>

	</head>

	<body>

		<header class="mui-bar mui-bar-nav app-header">
			<a class="mui-action-back app-icon-back mui-pull-left"></a>
			<h1 class="mui-title">发布说说</h1>
		</header>
		<div class="mui-content">
			<div class="tips2 app-font-size-30">
				添加标题
				<!--<span style="color: #9F9FA0;">(30字以内)</span>-->
				<input v-model="t0" maxlength="30" type="text" placeholder="30字以内" />
			</div>
			<div class="app-font-size-26 room" :data-ts="t1.length + '/300'">
				<textarea maxlength="300" rows="4" style="height: auto !important;" v-model="t1" placeholder="说说你的心得"></textarea>
			</div>

			<div class="tips2 app-font-size-30">
				添加说说图片
				<!--<span style="color: #a2a6b1;">(无限制)</span>-->
			</div>

			<div class="imgRoom app-font-size-26">
				<template v-for="o,i in imgs">
					<div :class="{'last': i === firstNullIndex, 'over': o !== ''}" :style="'background-image: url('+ o +')'" @tap="onImgTap(i)"></div>
				</template>
			</div>

			<!--<div class="app-font-size-26 room ps">
				<img src="../../../image/main/nearby.png" width="15px"/>
				<span>
					南山市西丽官龙第一工业区
				</span>
			</div>
			<div class="cityRoom">
				<div class="cardRoom color808080 app-font-size-24">

					<template v-for="o,i in hotList">
						<div v-text="o" @tap="onCityTap(o)"></div>
					</template>

				</div>
				
			</div>-->

			<button @tap="onSuccessTap()" type="button" class="mui-btn app-btn-main app-font-size-34">发布</button>

		</div>
		<script type="text/javascript" src="../../../js/common/immersed.js"></script>
		<script src="../../../js/lib/mui.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/vue.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/vue-ni.js"></script>

		<script type="text/javascript" src="../../../js/dal/base.js"></script>
		<script type="text/javascript" src="../../../js/dal/system.js"></script>
		<script type="text/javascript" src="../../../js/dal/article.js"></script>
		<script type="text/javascript" src="../../../js/app/app-rules.js"></script>

		<script type="text/javascript">
			
			
			
			new Vue({
				el: ".mui-content",
				data: function() {
					return {
						t0: "",
						t1: "",
						imgs: ["", "", ""],
						hotList: [
							"广州", 
							"东莞",
							"长沙",
							"惠州",
						],
						adress: "深圳",
						longitude: 0,
						latitude: 0,
						
						discover: null, // 发现页面
					};
				},
				computed: {
					firstNullIndex: function() {
						var i;
						for(i = 0; i < this.len; i++) {
							if(this.imgs[i] === "") {
								return i;
							}
						}
						return -1;
					},
					len: function() {
						return this.imgs.length;
					}
				},
				plusReady: function() {
					this.discover = plus.webview.getWebviewById('discover');
				},
				mounted: function() {

				},
				methods: {
					onImgTap: function(index) {
						var that = this;
						this.$gallery(function(err, imgArr) {
							if(err) {
								return mui.toast("图片选取失败");
							}
							if(imgArr.length > that.len) {
								mui.toast("您最多只能选择" + that.len + "张");
								imgArr = imgArr.splice(0, that.len);
							}

							// 先bind固定参数，再apply不定数量参数
							that.imgs.splice.bind(that.imgs, index, imgArr.length).apply(that.imgs, imgArr);

						}, this.len - index);
					},
					onSuccessTap: function() {
						var w = plus.nativeUI.showWaiting("正在处理图片...");
						var that = this;

						new Promise(function(re, rj) {

								var errMessage = app.rules.testListBy([{
										type: function(v) {
											v = v.trim();
											if(v.length === 0) {
												return '标题不能为空';
											}
											if(v.length > 30) {
												return '标题不能超过30个字'
											}
										},
										value: that.t0
									},
									{
										type: function(v) {
											if(v.length === 0) {
												return '心得不能为空';
											}
											if(v.length > 300) {
												return '心得不能超过300个字'
											}
										},
										value: that.t1
									},
									{
										type: function(arr) {
											for(var i in arr){
												if(arr[i] !== ''){return};
											}
											return '您至少上传一张图片';
										},
										value: that.imgs
									},
								]);
								
								if(errMessage) {
									rj(new Error(errMessage));
								}
								
								
								
								// 压缩图片
								new that.$Zip().processImage(that.imgs, 1000, function(err, data) {
									if(err) {
										return rj(err);
									}
									re(data);
								});
							})
							.then(function(imgs) {
								that.imgs = [];
								that.imgs.push.apply(that.imgs, imgs);
								// 提交服务器
								return new Promise(function(re, rj) {
									dal.system.uploadImg(that.imgs, function(err, imgList) {
										if(err) {
											return rj(err);
										}
										re(imgList);
									});
								});
							})
							.then(function(imgList) {
								// 提交发布说说
								w.setTitle("正在发布...");

								return new Promise(function(resolve, reject) {

									dal.article.add(that.t0.trim(), that.t1, imgList, function(err, data) {
										if(err) {
											return reject(err);
										}
										resolve(data);
									});
								});
							})
							.then(function() {
								w.close();
								mui.toast("发布成功");
								that.discover && new ni.Broadcast().emit("discover_update", {}, {
									views: ['discover'],
								});
								mui.back();
							})
							.catch(function(err) {
								w.close();
								//err.message
								mui.toast(err.message || "发布说说失败，请重试");
							});

					}
				},

			});
		</script>
	</body>

</html>