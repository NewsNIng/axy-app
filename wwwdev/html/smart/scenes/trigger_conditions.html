<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>智能场景</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="../../../js/common/flexible.js"></script>
		<link href="../../../css/lib/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../../css/app/app.css" />
		<link rel="stylesheet" href="../../../css/lib/mui.picker.css" />
		<link rel="stylesheet" href="../../../css/lib/mui.poppicker.css" />
		<link rel="stylesheet" href="../../../css/lib/mui.dtpicker.css" />
		<link rel="stylesheet" href="../../../css/app/module/poppicker.css" />
		<style type="text/css">
			html,
			body,
			.mui-content {
				background-color: #F4F8FB;
				overflow-x: hidden;
			}
			
			.mui-content {
				/*margin-bottom: 1.6rem;*/
			}
			
			.conditions_item {
				height: 1.6rem;
				padding-left: 0.346666rem;
				background-color: white;
				position: relative;
				/*border-bottom: 1px solid #E5E6E7;*/
			}
			
			.conditions_item:after {
				content: "";
				position: absolute;
				height: 1px;
				left: 0.346666rem;
				right: 0;
				bottom: 0;
				background-color: #E5E6E7;
			}
			
			.conditions_item:last-child:after {
				height: 0;
			}
			
			.conditions_item:active {
				background-color: #EFEFEF;
			}
			
			.condition_title {
				padding-left: 0.346666rem;
				height: 1.066666rem;
				line-height: 1.066666rem;
				color: #555555;
			}
			
			.conditions_icon,
			.more,
			.title {
				position: relative;
				top: 50%;
				transform: translateY(-50%);
				-webkit-transform: translateY(-50%);
			}
			
			.conditions_icon {
				float: left;
				width: 0.48rem;
			}
			
			.more {
				float: right;
				height: 0.4rem;
				right: 0.346666rem;
			}
			
			.title {
				padding-left: 0.826666rem;
				color: #333333;
			}
			
			.com-dev-mask {
				position: fixed;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5);
				z-index: 98;
			}
			
			.com-dev {
				position: fixed;
				left: 0;
				bottom: 0;
				width: 100%;
				/*min-height: 30%;*/
				z-index: 99;
				/*				background-color: #FFFFFF;*/
				background-color: #F4F8FB;
				/*max-height: 50%;*/
			}
			
			.com-dev:not(.time) .mui-table-view-cell {
				text-align: center;
				height: 1.386666rem;
				padding: 0;
				line-height: 1.386666rem;
			}
			
			.com-dev ul:last-child {
				margin-top: 0.266666rem;
			}
			
			.com-dev:not(.time) .mui-table-view-cell>a {
				height: 100%;
			}
			
			.com-dev:not(.time) .mui-table-view-cell>a:not(.mui-btn) {
				margin: 0;
			}
			
			.mui-table-view:after {
				height: 0;
			}
			
			.mui-table-view-cell:after {
				right: 15px;
				background-color: #E4E5E6;
			}
			
			.mui-badge {
				font-size: inherit;
				color: #9F9FA0;
				background-color: transparent !important;
				padding: 0 !important;
			}
			
			.com-dev.time>ul {
				margin-top: 0 !important;
			}
			
			.com-dev>ul>.mui-table-view-cell:after {
				left: 0;
				background-color: #F2F2F3;
			}
			
			.no_padding {
				padding: 0 !important;
			}
			
			.com-dev>ul>li {
				height: 1.2rem;
			}
			
			.com-dev .mui-btn {
				width: 1.733333rem;
				height: 0.72rem;
				line-height: 0.1rem !important;
				padding: 0;
				border: none;
				background-color: #E5E6E7;
				border-radius: 3px;
			}
			
			.com-dev .mui-btn.active {
				background-color: #06C1AE !important;
				color: #FFFFFF !important;
			}
			
			.cancel {
				color: #F8584F;
			}
			
			.scroll {
				max-height: 6.826666rem !important;
				overflow-x: hidden;
				overflow-y: scroll;
			}
			
			.mui-table-view:before {
				height: 0;
			}
			
			.mui-poppicker-header .mui-btn {
				font-size: 15px !important;
			}
			
			[data-dpr="2"] .mui-poppicker-header .mui-btn {
				font-size: 30px !important;
			}
			
			[data-dpr="3"] .mui-poppicker-header .mui-btn {
				font-size: 45px !important;
			}
			
			.pop_title {
				color: #333333;
				text-align: center;
			}
			
			.pop_title {
				height: 1.173333rem;
				line-height: 1.173333rem;
				border-bottom: 1px solid #E5E6E7;
				background-color: white;
			}
			
			.cancel {
				float: left;
				padding-left: 0.346666rem;
			}
			
			.ok {
				float: right;
				padding-right: 0.346666rem;
			}
			
			.repeat1 {
				padding: 0 15px;
				height: 100%;
			}
			
			.repeat1 .mui-btn {
				top: 50%;
				transform: translateY(-50%);
				-webkit-transform: translateY(-50%);
			}
			
			.repeat2 {
				height: 100%;
				padding: 0.266666rem 0 0 15px;
			}
			
			.repeat2 .mui-btn {
				margin: 0 0.11rem 0.213333rem 0;
			}
			
			.li_repeat2 {
				height: 2.186666rem !important;
			}
			/*.mui-table-view-cell:not(.clock_item):after {
				position: absolute;
				right: 0;
				bottom: 0;
				left: 0;
				height: 1px;
				content: '';
				-webkit-transform: scaleY(.5);
				transform: scaleY(.5);
				background-color: #c8c7cc;
			}*/
		</style>
	</head>

	<body>
		<div id="warpper">
			<header class="mui-bar mui-bar-nav app-header">
				<a class="mui-action-back app-icon-back mui-pull-left"></a>
				<h1 class="mui-title">添加触发条件</h1>
			</header>
			<!--<div class="com-dev-mask" v-show="mask" @tap.self="mask = false">
				<slot></slot>
				
			</div>-->
			<div class="com-dev-mask" v-show="mask" @tap.self="mask = false">
				<div class="com-dev time app-font-size-28" v-show="index === 0">
					<div class="pop_title app-font-size-28">

						<div class="cancel app-color-9f9fa0" @tap.self="onCancelTap()">取消</div>
						<div class="ok app-color-main" @tap.self="onTimeTap()">确定</div>
					</div>
					<ul class="mui-table-view">
						<!--<li class="mui-table-view-cell">
							<a class="">
								<span>重复</span>
								<span class="mui-badge">
									<div class="mui-switch mui-switch-mini app-switch-main" :class="{'mui-active ': isRepeat}" ref="pwd_protection">
										<div class="mui-switch-handle"></div>
									</div>
								</span>
							</a>
						</li>-->
						<li class="mui-table-view-cell no_padding">
							<div class="repeat1">
								<button type="button" class="mui-btn app-font-size-26" :class="everyDay && 'active'" @tap="onEveryDayTap()">每天</button>
								<button type="button" class="mui-btn app-font-size-26" :class="sleepDay && 'active'" @tap="onSleepDayTap()">周末</button>
								<button type="button" class="mui-btn app-font-size-26" :class="workDay && 'active'" @tap="onWorkDayTap()">工作日</button>
							</div>

						</li>
						<li class="mui-table-view-cell li_repeat2 no_padding">
							<div class="repeat2">
								<template v-for="o,i in weeks">
									<button @tap="onWeekTap(o, i)" type="button" class="mui-btn app-font-size-26" :class="o && 'active'">周{{_number2string(i)}}</button>
								</template>

							</div>
						</li>
						<li class="mui-table-view-cell" @tap="onPickTap(0)">
							<a class="mui-navigate-right">
								<span>设置时间</span>
								<span class="mui-badge" v-text="clockTime"></span>
							</a>
						</li>
					</ul>
				</div>
				<div class="com-dev app-font-size-28" v-show="index !== 0 && index < 4">
					<ul class="mui-table-view app-font-size-30 scroll">
						<li class="mui-table-view-cell" @tap="onSelectedTap(o)" v-for="o,i in selectList">
							<a class="">
								<span>{{o.text}}</span>
							</a>
						</li>

					</ul>
					<ul class="mui-table-view app-font-size-30">
						<li class="mui-table-view-cell" @tap="onCancelTap()">
							<a class="">
								<span>取消</span>
							</a>
						</li>
					</ul>
				</div>
				<div class="com-dev app-font-size-28" v-show="index >= 4">
					<ul class="mui-table-view app-font-size-30 scroll">
						<li class="mui-table-view-cell" v-for="o,i in selectList" @tap="onSecondaryTap(o)">
							<a class="">
								<span>{{o.text}}</span>
							</a>
						</li>

					</ul>
					<ul class="mui-table-view app-font-size-30">
						<li class="mui-table-view-cell" @tap="onCancelTap()">
							<a class="">
								<span>取消</span>
							</a>
						</li>
					</ul>
				</div>
			</div>
			<div class="mui-content">
				<div v-for="o,i in conditions" class="conditions_item" @tap="onSelectDevTap(i, o)">
					<!--<div class="condition_title app-font-size-28" v-text="o.title"></div>-->
					<!--<div class="conditions_item app-font-size-28" v-for="o1,i in o.list" @tap="onSelectDevTap(i,o1.img)">-->
					<img class="conditions_icon" :src="getIconByConditionId(o.conditiontype)" />
					<img class="more" src="../../../image/smart/scenes/btn_More@3x.png" />
					<div class="title app-font-size-28">{{o.name}}</div>
					<!--</div>-->
					<!--<div v-if="i !== conditions.length - 1" style="float: left; margin-left: 0.346666rem; height: 1px; width: 100%; background-color: #E5E6E7;"></div>-->
					</template>
				</div>
			</div>
			<!--沉浸式动态处理-->
			<script type="text/javascript" src="../../../js/common/immersed.js"></script>

			<!--基础配置-->
			<script type="text/javascript" src="../../../js/config.js"></script>
			<!--基础库-->
			<script type="text/javascript" src="../../../js/lib/mui.min.js"></script>
			<script type="text/javascript" src="../../../js/lib/vue.min.js"></script>
			<script type="text/javascript" src="../../../js/lib/vue-ni.js"></script>
			<!--请求相关-->
			<script type="text/javascript" src="../../../js/dal/base.js"></script>
			<!--App相关业务逻辑-->
			<script type="text/javascript" src="../../../js/app/app.js"></script>
			<script type="text/javascript" src="../../../js/app/app-page.js"></script>

			<script type="text/javascript" src="../../../js/lib/mui.picker.js"></script>
			<script type="text/javascript" src="../../../js/lib/mui.poppicker.js"></script>
			<script type="text/javascript" src="../../../js/lib/mui.dtpicker.js"></script>
			<script type="text/javascript" src="../../../js/data/time_hm.js"></script>
			<script type="text/javascript" src="../../../js/data/value_0-1000.js"></script>
			<script type="text/javascript" src="../../../js/app/app-act.js"></script>
			<script type="text/javascript" src="../../../js/dal/scene.js"></script>

			<script type="text/javascript">
				mui.init();

				new Vue({
					el: '#warpper',
					data: function() {
						return {
							weeks: [true, true, true, true, true, true, true],
							clockTime: "00:00",
							durationTime: 0,
							mask: false, // 遮罩控制
							index: -1, // 弹窗索引
							numValue: 0, // 指定值
							conditions: app.act.getConditions(),
							mask: false, // 遮罩控制
							conditionsMapList: [],
							conditionsMapObj: {
								"devlist": [{
										"devid": "AX-00000",
										"devname": "devicename1"
									},
									{
										"devid": "AX-00001",
										"devname": "devicename2"
									}
								],
								"acclist": [{
										"accID": "12345678",
										"accName": "accName0",
										"extend": {
											"lightPos": [1, 2, 3]
										}
									},
									{
										"accID": "12345679",
										"accName": "accName1"
									}
								],
								"irc": [{
										"irID": "adfaf132a1564adf1321a3d2f",
										"ircName": "ircName0"
									},
									{
										"irID": "adfaf132a1564adf1321a3d2f",
										"ircName": "ircName0"
									}
								]
							},
							selectList: [],
							devDelay: -1,
							devDelayText: "",
						};
					},
					computed: {
						workDay: function() {
							return this.needDayIndexs === '01234';
						},
						sleepDay: function() {
							return this.needDayIndexs === '56';
						},
						everyDay: function() {
							return this.needDayIndexs === '0123456';
						},

						needDayIndexs: function() {
							return this.weeks.reduce(function(str, item, index) {
								if(item) {
									str += index;
								}
								return str;
							}, '');
						}
					},
					mounted: function() {
						this.dtpicker = new mui.DtPicker({
							"type": "time",
						})
					},
					plusReady: function() {},
					methods: {
						onSelectDevTap: function(i, o) {
							var _this = this;
							_this.index = i;
							if(i > 0) {
								if(!this.conditionsMapList[i]) {
									plus.nativeUI.showWaiting();
									dal.scene.getDevListByCondition(o.conditiontype, function(err, data) {
										plus.nativeUI.closeWaiting();
										if(err) {
											return mui.toast(err.message);
										}
										_this.conditionsMapList[i] = data;
										_this.setSelectList();
										if(_this.selectList.length == 0) { //如果没有数据不给选择
											return mui.toast('暂无可选值')
										} else if(_this.selectList.length == 1) {
											var firstSelectItem = _this.selectList[0];
											if(i < 4) {
												_this.onSelectedTap(firstSelectItem)
											} else {
												_this.onSecondaryTap(firstSelectItem)
											}
										}
										_this.mask = true;
										_this.conditionType = o.conditiontype
									})
								} else {
									_this.setSelectList();
									if(_this.selectList.length == 0) { //如果没有数据不给选择
										return mui.toast('暂无可选值')
									} else if(_this.selectList.length == 1) {
										var firstSelectItem = _this.selectList[0];
										if(i < 4) {
											_this.onSelectedTap(firstSelectItem)
										} else {
											_this.onSecondaryTap(firstSelectItem)
										}
									}
									_this.mask = true;
									_this.conditionType = o.conditiontype
								}
							} else {
								_this.mask = true;
								_this.conditionType = o.conditiontype
							}
						},
						onCancelTap: function() {
							this.mask = false;
						},
						onSelectedTap: function(o) {
							this.mask = false;
							var result = {
								name: o.name || o.text || o.value,
								conditionType: this.conditionType,
							}
							if(o.value !== undefined) {
								var typeId;
								if(o.type == 'devlist') {
									typeId = 'devId'
								} else {
									typeId = 'accId'
								}
								result[typeId] = o.value;
							}
							o.devId !== undefined && (result.devId = o.devId) //设备id
							o.accId !== undefined && (result.accId = o.accId) //配件id
							o.time !== undefined && (result.time = o.time);
							o.recycle !== undefined && (result.recycle = o.recycle);
							o.temperature !== undefined && (result.temperature = o.temperature);
							o.humidity !== undefined && (result.humidity = o.humidity);
							o.concentration !== undefined && (result.concentration = o.concentration);
							app.page.setResult(result).close();
						},
						_number2string: function(i) {
							return ["一", "二", "三", "四", "五", "六", "日"][i];
						},
						onWeekTap: function(o, index) {
							this.$set(this.weeks, index, !o);
						},

						onEveryDayTap: function() {
							this.weeks = this.weeks.map(function() {
								return !this.everyDay;
							}.bind(this));
						},
						onWorkDayTap: function() {
							if(this.workDay) {
								this.weeks = this.weeks.map(function() {
									return false;
								});
							} else {
								this.weeks = [true, true, true, true, true, false, false];
							}

						},
						onSleepDayTap: function() {
							if(this.sleepDay) {
								this.weeks = this.weeks.map(function() {
									return false;
								});
							} else {
								this.weeks = [false, false, false, false, false, true, true];
							}
						},
						onPickTap: function(i) {
							var that = this;
							this.dtpicker.show(function(selectItems) {
								that.clockTime = selectItems.value;
							});
						},
						onTimeTap: function() {
							var recycle = this.weeks.map(function(item) {
								return item ? 1 : 0;
							})
							var timeArr = (this.clockTime + '').split(':');
							var time = timeArr[0] * 3600 + timeArr[1] * 60;
							var name = this.clockTime + "(" + this.weeks.reduce(function(prev, cur, index) {
								return prev + (cur ? '周' + this._number2string(index) + ' ' : '');
							}.bind(this), '').slice(0, -1) + ")";
							this.onSelectedTap({
								name: name,
								recycle: recycle,
								time: time
							});
						},
						onSecondaryTap: function(o, i) {
							var id = o.text || o.value;
							var _this = this;
							var conditionType = _this.conditionType;
							var conditionName = app.act.getConditionNameById(conditionType).slice(0, -3)
							_this.pick = new mui.PopPicker({
								layer: 1
							});
							_this.pick.setData(thousandValue);
							_this.pick.pickers[0].setSelectedIndex(this.numValue);

							_this.pick.show(function(items) {
								_this.numValue = items[0].value;
								var name = '' + id + '(' + conditionName + _this.numValue + ')';
								var obj = {
									name: name,
								};
								if(o.type == 'acclist') {
									obj.accId = o.value
								}
								if(o.type == 'devlist') {
									obj.devId = o.value
								}
								if(conditionType == 0x400 || conditionType == 0x401) {
									obj.temperature = _this.numValue
								} else if(conditionType == 0x500 || conditionType == 0x501) {
									obj.humidity = _this.numValue
								} else {
									obj.concentration = _this.numValue
								}
								_this.onSelectedTap(obj);
							});
						},
						setSelectList: function() {
							var returnList = [];
							var _this = this;
							var conditionsMapObj = this.conditionsMapList[this.index];
							_this.selectListHeigt = 1;
							for(var i in conditionsMapObj) {
								var item = conditionsMapObj[i];
								if(item && item.length > 0) {
									item.forEach(function(devObj, index) {
										var type = i;
										if(type == 'devlist') {
											returnList.push({
												value: devObj['devid'],
												text: devObj['devname'],
												type: 'devlist',
												typeName: 'devtype',
												typeNumber: devObj['devtype'],
											})
										} else if(type == 'acclist') {
											var temp = {
												value: devObj['accID'],
												text: devObj['accName'],
												type: 'acclist',
												typeName: 'acctype',
												typeNumber: devObj['acctype'],
											}
											returnList.push(temp)
										} else if(type == 'irclist') {
											returnList.push({
												value: devObj['irID'],
												text: devObj['ircName'],
												type: 'irclist',
												typeName: 'irctype',
												typeNumber: devObj['irctype'],
											})
										}
									})
								}
							}
							this.selectList = returnList;
						},
						getIconByConditionId: function(conditionId) {
							return app.act.getIconByConditionId(conditionId)
						}
					},
				});
			</script>
	</body>

</html>