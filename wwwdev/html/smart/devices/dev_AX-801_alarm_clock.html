<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>GPRS报警主机设置</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="../../../js/common/flexible.js"></script>
		<link href="../../../css/lib/mui.min.css" rel="stylesheet" />
		<!--<link rel="stylesheet" href="../../../css/lib/mui.picker.css" />
		<link rel="stylesheet" href="../../../css/lib/mui.poppicker.css" />
		<link rel="stylesheet" href="../../../css/app/app.poppicker.css" />-->

		<link rel="stylesheet" href="../../../css/app/app.css" />
		<link rel="stylesheet" href="../../../css/lib/mui.picker.css" />
		<link rel="stylesheet" href="../../../css/lib/mui.poppicker.css" />
		<link rel="stylesheet" href="../../../css/app/module/poppicker.css" />

		<style type="text/css">
			html,
			body,
			.mui-content {
				background-color: #F4F8FB;
			}
			
			.mui-content {
				padding-bottom: 1.333333rem;
			}
			
			.mui-badge {
				font-size: inherit;
				color: #9F9FA0;
				background-color: transparent !important;
				padding: 0 !important;
			}
			
			.img-wrap {
				height: 0;
				padding-bottom: 7.866666rem;
				background-repeat: no-repeat;
				background-size: 60%;
				background-position: bottom;
			}
			
			.menu-warp {
				height: 2.986666rem;
			}
			
			.edit,
			.del {
				width: 1.146666rem;
				padding: 0 !important;
				justify-content: center;
			}
			
			.mui-table-view-cell>.mui-slider-right>.mui-btn:after {
				left: 0;
			}
			
			.mui-slider-right {
				/*width: 2.3rem;*/
			}
			
			.edit {
				background-color: #C7C7CC;
			}
			
			.del {
				background-color: #FF3B30;
			}
			
			.clock_item,
			.mui-slider-handle {
				height: 2.133333rem;
			}
			
			.clock_item {
				margin-top: 0.266666rem;
				padding: 0 0.346666rem;
				background-color: white;
			}
			
			.item_value {
				display: -webkit-flex;
				display: flex;
				flex-direction: column;
				justify-content: space-around;
			}
			
			.time {
				color: #303030;
				line-height: 1;
			}
			
			.day {
				color: #3E3E3E;
			}
			
			.mui-table-view-cell:after {
				content: none;
			}
			
			.item_value .mui-badge,
			.item_value .mui-btn,
			.item_value .mui-switch {
				position: absolute;
				top: 50%;
				right: 15px;
				-webkit-transform: translateY(-50%);
				transform: translateY(-50%);
			}
			
			.com-dev>ul {
				margin-top: 0 !important;
			}
			
			.com-dev>ul>.mui-table-view-cell:after {
				left: 0;
				background-color: #F2F2F3;
			}
			
			.no_padding {
				padding: 0 !important;
			}
			
			.com-dev>ul>li {
				height: 1.2rem;
			}
			/*.mui-switch-handle {
				height: 18px !important;
				width: 18px !important;
			}
			
			.app-switch-main {
				height: 20px;
				width: 36px;
			}*/
			
			.com-dev .mui-btn {
				width: 1.733333rem;
				height: 0.72rem;
				line-height: 0.1rem !important;
				padding: 0;
				border: none;
				background-color: #E5E6E7;
				border-radius: 3px;
			}
			
			.com-dev .mui-btn.active {
				background-color: #06C1AE !important;
				color: #FFFFFF !important;
			}
			
			.com-dev-mask {
				position: fixed;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5);
				z-index: 98;
			}
			
			.com-dev {
				position: fixed;
				left: 0;
				bottom: 0;
				width: 100%;
				min-height: 30%;
				z-index: 99;
				/*				background-color: #FFFFFF;*/
				background-color: #FBFCFD
			}
			
			.pop_title {
				color: #333333;
				text-align: center;
			}
			
			.pop_title {
				height: 1.173333rem;
				line-height: 1.173333rem;
				border-bottom: 1px solid #E5E6E7;
				background-color: white;
			}
			
			.cancel {
				float: left;
				padding-left: 0.346666rem;
			}
			
			.ok {
				float: right;
				padding-right: 0.346666rem;
			}
			
			.repeat1 {
				padding: 0 15px;
				height: 100%;
			}
			
			.repeat1 .mui-btn {
				top: 50%;
				transform: translateY(-50%);
				-webkit-transform: translateY(-50%);
			}
			
			.repeat2 {
				height: 100%;
				padding: 0.266666rem 0 0 15px;
			}
			
			.repeat2 .mui-btn {
				margin: 0 0.11rem 0.213333rem 0;
			}
			
			.li_repeat2 {
				height: 2.186666rem !important;
			}
			
			.mui-table-view-cell:not(.clock_item):after {
				position: absolute;
				right: 0;
				bottom: 0;
				left: 0;
				height: 1px;
				content: '';
				-webkit-transform: scaleY(.5);
				transform: scaleY(.5);
				background-color: #c8c7cc;
			}
			
			.app-font-size-68 {
				font-size: 34px !important;
			}
			
			[data-dpr="2"] .app-font-size-68 {
				font-size: 68px !important;
			}
			
			[data-dpr="3"] .app-font-size-68 {
				font-size: 102px !important;
			}
			
			.mui-switch.mui-disabled {
				opacity: 1 !important;
			}
		</style>
	</head>

	<body>
		<div id="warpper">

			<header class="mui-bar mui-bar-nav app-header" data-top='0' data-offset='150' data-duration='16'>
				<a class="mui-action-back app-icon-back mui-pull-left"></a>
				<h1 class="mui-title">闹钟</h1>
				<a class="app-icon-plus mui-pull-right" @tap="onAddTap()"></a>
			</header>

			<div class="com-dev-mask" v-show="mask" @tap.self="mask = false">
				<slot></slot>
				<div class="com-dev app-font-size-28" v-show="index === 1">
					<div class="pop_title app-font-size-28">

						<div class="cancel app-color-9f9fa0" @tap="onCancel()">取消</div>
						<div class="ok app-color-main" @tap="onSave()">确定</div>
					</div>
					<ul class="mui-table-view">
						<!--<li class="mui-table-view-cell">
							<a class="">
								<span>重复</span>
								<span class="mui-badge">
									<div class="mui-switch mui-switch-mini app-switch-main" :class="{'mui-active ': isRepeat}" ref="pwd_protection">
										<div class="mui-switch-handle"></div>
									</div>
								</span>
							</a>
						</li>-->
						<li class="mui-table-view-cell no_padding">
							<div class="repeat1">
								<button type="button" class="mui-btn app-font-size-26" :class="everyDay && 'active'" @tap="onEveryDayTap()">每天</button>
								<button type="button" class="mui-btn app-font-size-26" :class="sleepDay && 'active'" @tap="onSleepDayTap()">周末</button>
								<button type="button" class="mui-btn app-font-size-26" :class="workDay && 'active'" @tap="onWorkDayTap()">工作日</button>
							</div>

						</li>
						<li class="mui-table-view-cell li_repeat2 no_padding">
							<div class="repeat2">
								<template v-for="o,i in weeks">
									<button @tap="onWeekTap(o, i)" type="button" class="mui-btn app-font-size-26" :class="o && 'active'">周{{_number2string(i)}}</button>
								</template>

							</div>
						</li>
						<li class="mui-table-view-cell" @tap="onPickTap(0)">
							<a class="mui-navigate-right">
								<span>设置时间</span>
								<span class="mui-badge">{{_formatTime(clockTime)}}</span>
							</a>
						</li>
						<li class="mui-table-view-cell" @tap="onPickTap(1)">
							<a class="mui-navigate-right">
								<span>响铃时长</span>
								<span class="mui-badge">{{durationTime}}秒</span>
							</a>
						</li>
						<!--<li class="mui-table-view-cell" @tap="onRingTap()">
							<a class="mui-navigate-right">
								<span>铃声</span>
								<span class="mui-badge" v-text="ringtones"></span>
							</a>
						</li>-->
						<li class="mui-table-view-cell">
							<a>
								<span>稍后提醒</span>
								<span class="mui-badge" @click="changeClockRepeat">
								<div class="mui-switch mui-switch-mini app-switch-main mui-disabled" :class="{'mui-active ': repeat}">
									<div class="mui-switch-handle"></div>
								</div>
								</span>
							</a>
						</li>

					</ul>
				</div>
			</div>

			<div class="mui-content">
				<div class="clock_item mui-table-view-cell" v-for="o,i in alarmClocks" :key="o.id">
					<div class="mui-slider-right mui-disabled app-font-size-28">
						<a class="mui-btn mui-btn-red edit" @click="handleEditClock(o,i,$event)">编辑</a>
						<a class="mui-btn mui-btn-red del" @click="handleDelClock(o,i,$event)">删除</a>
					</div>
					<div class="mui-slider-handle item_value">
						<span class="" @click="changeClockEnable(o)">
							<div class="mui-switch mui-switch-mini app-switch-main mui-disabled" :class="{'mui-active ':o.enable}">
								<div class="mui-switch-handle"></div>
							</div>
						</span>
						<span class="time app-font-size-68">{{_formatTime(o.time)}}</span>
						<div class="day app-font-size-30">
							<span class="day-item">{{_weeksToString(o.weekdays)}}</span>
						</div>
					</div>
				</div>
			</div>

		</div>
		<!--沉浸式动态处理-->
		<script type="text/javascript" src="../../../js/common/immersed.js"></script>

		<!--基础库-->
		<script type="text/javascript" src="../../../js/lib/mui.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/vue.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/vue-ni.js"></script>
		<!--请求相关-->
		<script type="text/javascript" src="../../../js/dal/base.js"></script>
		<script type="text/javascript" src="../../../js/dal/device.js"></script>
		<script type="text/javascript" src="../../../js/dal/devparam.js"></script>
		<!--App相关业务逻辑-->
		<script type="text/javascript" src="../../../js/app/app.js"></script>
		<script type="text/javascript" src="../../../js/app/app-dev.js"></script>
		<script type="text/javascript" src="../../../js/app/app-page.js"></script>

		<!--<script type="text/javascript" src="../../../js/lib/md5.min.js"></script>-->
		<!--<script type="text/javascript" src="../../../js/common/imagelazyload.js"></script>-->

		<script type="text/javascript" src="../../../js/lib/mui.picker.js"></script>
		<script type="text/javascript" src="../../../js/lib/mui.poppicker.js"></script>
		<script type="text/javascript" src="../../../js/data/time_hm_all.js"></script>
		<script type="text/javascript" src="../../../js/data/time_s.js"></script>
		<script type="text/javascript" src="../../../js/lib/Rx.min.js"></script>

		<script type="text/javascript" src="../../../js/app/app-auth.js"></script>
		<script src="../../../js/dal/ax_801.js" type="text/javascript" charset="utf-8"></script>

		<script type="text/javascript">
			mui.init();

			var _B = new ni.Broadcast();

			new Vue({
				el: '#warpper',
				data: function() {
					return {
						weeks: [true, true, true, true, true, true, true],
						clockTime: 7200,
						durationTime: 30,
						repeat: true,
						enable: true,
						mask: false, // 遮罩控制
						index: -1, //是否弹框
						//						ringtones: '欢乐时光', //暂不支持
						alarmClocks: [{
								"id": 0,
								"time": 3601,
								"diaboloDuration": 2,
								"enable": true,
								"weekdays": [
									false,
									true,
									true,
									true,
									true,
									true,
									false
								],
								"repeat": true
							},
							{
								"id": 1,
								"time": 7360,
								"diaboloDuration": 2,
								"enable": true,
								"weekdays": [
									false,
									true,
									true,
									true,
									true,
									true,
									false
								],
								"repeat": true
							}
						],
					};
				},
				computed: {
					workDay: function() {
						return this.needDayIndexs === '01234';
					},
					sleepDay: function() {
						return this.needDayIndexs === '56';
					},
					everyDay: function() {
						return this.needDayIndexs === '0123456';
					},

					needDayIndexs: function() {
						return this.weeks.reduce(function(str, item, index) {
							if(item) {
								str += index;
							}
							return str;
						}, '');
					}
				},
				mounted: function() {
					//					this.$refs.switch1.addEventListener("toggle", function(event) {
					//						var that = this;
					//						// 发送更改请求
					//						plus.nativeUI.showWaiting();
					//
					//					}.bind(this));
					this.pick = new mui.PopPicker({
						layer: 2,
						more: true
					});
					this.pick.setData(pick_data);
				},
				plusReady: function() {
					this.devid = this.$view.devid;
					this.type = this.$view.type;
					this.getAlarmClockList();
				},
				methods: {
					getAlarmClockList: function(){
						var devid = this.devid;
						var type = this.type;
						return dal.aiBox.getAlarmClockList(devid,type,function(err,data){
							if(err){
								return mui.toast(err.message)
							}
							this.alarmClocks = data;
						})
					},
					onAddTap: function() {
						//						if(this.plans.length >= 8) {
						//							return mui.toast("计划最多为8个，请删除其它");
						//						}
						this.mask = true;
						this.index = 1;
						this.actionType = -1; //表示新增
						this.durationTime = 30;
						var date = new Date();
						this.clockTime = date.getHours() * 3600 + date.getMinutes() * 60;
					},
					onWeekTap: function(o, index) {
						this.$set(this.weeks, index, !o);
					},

					onEveryDayTap: function() {
						this.weeks = this.weeks.map(function() {
							return !this.everyDay;
						}.bind(this));
					},
					onWorkDayTap: function() {
						if(this.workDay) {
							this.weeks = this.weeks.map(function() {
								return false;
							});
						} else {
							this.weeks = [true, true, true, true, true, false, false];
						}

					},
					onSleepDayTap: function() {
						if(this.sleepDay) {
							this.weeks = this.weeks.map(function() {
								return false;
							});
						} else {
							this.weeks = [false, false, false, false, false, true, true];
						}
					},
					_number2string: function(i) {
						return ["一", "二", "三", "四", "五", "六", "日"][i];
					},
					_weeksToString: function(arr) {
						var temp = ["一", "二", "三", "四", "五", "六", "日"];
						var isEveryday = arr.every(function(item) {
							return !!item
						})
						if(isEveryday) return '每天'
						var arrMapStr = arr.map(function(item, index) {
							return item ? '1' : '0'
						}).join('')
						if(arrMapStr == '1111100') {
							return '工作日'
						} else if(arrMapStr == '0000011') {
							return '周末'
						} else {
							return arr.map(function(item, index) {
								if(item) {
									return '周' + temp[index]
								}
							}).filter(function(item) {
								return item
							})
						}
					},
					_formatTime: function(time) {
						var hour = parseInt(time / 3600);
						var min = parseInt(time % 3600 / 60);
						hour = hour < 10 ? ('0' + hour) : hour;
						min = min < 10 ? ('0' + min) : min;
						if(isNaN(hour)) return '';
						return hour + ':' + min;
					},
					// 取消
					onCancel: function() {
						this.mask = false;
					},
					// 保存操作
					onSave: function() {
						var _this = this;
						this.mask = false;
						var clockObj = {
							"time": this.clockTime,
							"diaboloDuration": this.durationTime,
							"enable": this.enable,
							"weekdays": this.weeks,
							"repeat": this.repeat,
							"devid": this.devid,
							"type": this.type
						}

						if(this.actionType === -2) {
							// 删除	

						} else if(this.actionType === -1) {
							// 新增
							clockObj.enable = true;
							this.addAlarmClock(clockObj, function(err, data){
								if(err){
									return mui.toast(err.message)
								}
								_this.alarmClocks.push(data)
							})
						} else {
							// 修改
							clockObj.id = this.clockId;
							this.updateAlarmClock(clockObj, function(err, data){
								if(err){
									return mui.toast(err.message)
								}
								var index = this.currentEditIndex;
								_this.alarmClocks.splice(index,1,data);
							})
						}


					},
					addAlarmClock: function(clockObj, callback){
						return dal.aiBox.addAlarmClock(clockObj, callback)
					},
					onPickTap: function(i) {
						var that = this;
						if(!i) { //设置时间
							this.pick = new mui.PopPicker({
								layer: 2,
								more: true
							});
							this.pick.setData(pick_data);
							if(that.clockTime) {
								var hour = that._formatTime(that.clockTime).split(':')[0];
								var min = that._formatTime(that.clockTime).split(':')[1];
								this.pick.pickers[0].setSelectedValue(hour);
								this.pick.pickers[1].setSelectedValue(min);
							}

							this.pick.show(function(items) {
								var h = items[0].value,
									m = items[1].value;

								that.clockTime = h * 3600 + m * 60;

							}, function(items) {

							});
						} else { //响铃时长
							this.pick = new mui.PopPicker({
								layer: 1,
								more: true
							});
							this.pick.setData([pick_data_s]);
							this.pick.pickers[0].setSelectedValue(that.durationTime);

							this.pick.show(function(items) {

								that.durationTime = items[0].value;

							}, function(items) {

							});

						}
					},
					onRingTap: function() {
						app.page.openForResultBy('dev_AX_801_select_ring.html', 'dev_AX_801_select_ring', function(data) {
							this.ringtones = data.ringtones;
						}.bind(this), {
							ringtones: this.ringtones,
						});
					},
					handleDelClock: function(o, i, e) {
						var ele = e.target;
						var _this = this;
						mui.confirm('确认删除该条记录？', '提示', ['确认', '取消'], function(e) {
							var isDelete = e.index == 0;
							var clockId = o.id;
							mui.swipeoutClose(ele.parentNode.parentNode);
							if(isDelete) {
								_this.deleteClock(clockId, function(err, data) {
									if(err) {
										return mui.toast(err.message)
									}
									_this.alarmClocks.splice(i, 1)
								})
							}
						})
					},
					deleteClock: function(id, callback) {
						var devid = this.devid;
						var type = this.type;
						dal.aiBox.delAlarmClock(id, devid, type, callback);
					},
					handleEditClock: function(o, i, e){
						var ele = e.target;
						var _this = this;
						mui.swipeoutClose(ele.parentNode.parentNode);
						this.mask = true;
						this.index = 1;
						this.actionType = 0; //表示编辑
						this.durationTime = o.diaboloDuration;
						this.clockTime = o.time;
						this.repeat = o.repeat;
						this.enable = o.enable;
						this.weeks = o.weekdays;
						this.clockId = o.id;
						this.currentEditIndex = i;
					},
					changeClockEnable: function(o) {
						var enable = o.enable;
						var tempObj = JSON.parse(JSON.stringify(o));
						tempObj.enable = !enable;
						this.updateClock(o, function(err, data) {
							if(err) {
								return mui.toast(err.message)
							}
							o.enable = !enable;
						})
					},
					updateClock: function(o, callback) {
						dal.aiBox.updateAlarmClock(o, callback)
					},
					changeClockRepeat: function(){
						this.repeat = !this.repeat;
					}
				}
			});
		</script>
	</body>

</html>