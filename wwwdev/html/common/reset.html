<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>重置密码</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/lib/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/app/app.css" />
		<script type="text/javascript" src="../../js/common/flexible.js"></script>
		<style type="text/css">
			html,
			body {
				overflow: hidden;
			}
			
			html,
			body,
			.mui-content {
				background-color: white;
			}
			
			.mui-content {
				padding-bottom: 2rem;
			}
			
			.mui-bar-nav,
			.mui-bar {
				background-color: #FFFFFF;
				box-shadow: 0 0 0 white !important;
			}
			
			.mui-pull-right {
				line-height: 44px;
			}
			
			.app-color-main {
				color: #2bb8aa;
			}
			
			.app-color-gray {
				color: #666666;
			}
			
			div.mui-input-row>img {
				display: block;
				width: 0.64rem;
				height: 0.64rem;
				position: absolute;
				top: 0.46rem;
				left: 0.106666rem;
			}
			
			div.mui-input-row>input {
				padding-left: 1.173333rem;
				height: 100%;
				border: none;
				border-radius: 0;
				border-bottom: 1px solid #CCCCCC;
			}
			
			div.mui-input-row>input::-webkit-input-placeholder {
				color: #CCCCCC;
			}
			
			.mui-content>div.mui-input-row {
				display: block;
				width: 8.4rem;
				height: 1.6rem;
				margin: 0 auto;
				position: relative;
			}
			
			.mui-content>img {
				display: block;
				width: 2.186666rem;
				height: 2.186666rem;
				margin: 0.4rem auto 0.4rem auto;
			}
			/*登录按钮*/
			
			button.app-btn-main {
				width: 8.4rem;
				height: 1.173333rem;
				margin: 0.8rem 0.826666rem 0.56rem 0.826666rem;
			}
			
			.forget_pwd {
				color: #999999;
				text-align: right;
				padding-right: 0.826666rem;
			}
			
			.third_party_login {
				/*background-color: #CCCCCC;*/
				margin-top: 1.8rem;
				height: 0.8rem;
			}
			
			.third_party_login {
				color: #999999;
				position: relative;
			}
			/*第三方登录横线*/
			
			.third_party_login:before {
				content: "";
				width: 8.4rem;
				position: absolute;
				left: 0.826666rem;
				top: 50%;
				height: 1px;
				background-color: #999999;
				display: block;
				transform: translateY(-50%) scaleY(0.5);
				-webkit-transform: translateY(-50%) scaleY(0.5);
			}
			/*第三方登录文字*/
			
			.third_party_login>div {
				display: inline-block;
				text-align: center;
				padding: 0 0.2rem;
				position: absolute;
				background-color: white;
				left: 50%;
				top: 50%;
				transform: translate(-50%, -50%);
				-webkit-transform: translate(-50%, -50%);
			}
			
			.third_party_login>div.imgRoom {
				width: 100%;
				margin: 1.5rem 0.36rem;
				padding: 0;
			}
			
			.third_party_login>div.imgRoom>img {
				float: left;
				width: 0.906666rem;
				height: 0.906666rem;
				margin-left: 1.64rem;
			}
			/*注册按钮*/
			
			button.app-btn-main {}
			/*发送验证码*/
			
			.mui-content .send_code {
				color: #2BB8AA;
				position: absolute;
				top: 0.466666rem;
				right: 0;
				width: 1.8rem;
				padding: 0.133333rem 0.1rem 0.1rem 0.1rem;
			}
			/*同意协议*/
			
			.mui-content .agree_select {
				width: 0.3rem;
				height: 0.3rem;
				float: left;
				margin: 0.133333rem;
				border: 0.026666rem solid #d3d3d3;
				border-radius: 4px;
				;
			}
			
			.mui-content .agree_text {
				float: left;
				line-height: 0.566666rem;
				color: #999999;
			}
			
			.red {
				background-color: #1ABC9C;
			}
			
			.user_agree {
				padding: 0.4rem 0;
				overflow: hidden;
				width: 56%;
				margin: 0 auto;
			}
			
			.user_service {
				color: #1abc9c;
			}
			
			.mui-content>button.mui-btn {
				margin-bottom: 0;
			}
			
			.mui-icon {
				font-size: 32px !important;
				font-weight: bold;
				color: #666666 !important;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav app-header">
			<a class="mui-action-back mui-icon mui-icon-closeempty mui-pull-left app-color-gray">
			</a>
		</header>

		<div class="mui-content">

			<img src="../../image/common/login_logo.png" />

			<div class="mui-input-row app-font-size-30">
				<img src="../../image/common/login_account.png" />
				<input type="tel" class="app-font-size-28" placeholder="请输入手机号码" v-model="username">
			</div>

			<div class="mui-input-row app-font-size-30">
				<img src="../../image/common/login_msg.png" />
				<input type="tel" class="app-font-size-28" placeholder="请输入短信验证码" v-model="verifycode">
				<button type="button" @tap="getCodeTap()" class="send_code app-font-size-22 mui-btn mui-btn-grey mui-btn-outlined" :class="{'mui-disabled': codeState}" v-text="codeState ? (codeTimer + 's'): '发送验证码'"></button>
			</div>
			<button type="button" id="loginBtn" data-loading-icon="mui-spinner mui-spinner-custom" data-loading-text="请稍后..." class="mui-btn app-btn-main app-font-size-32" @tap="onLoginTap($event)">下一步</button>
		</div>

		<script type="text/javascript" src="../../js/common/immersed.js"></script>

		<script src="../../js/lib/mui.min.js"></script>
		<script type="text/javascript" src="../../js/lib/vue.min.js"></script>

		<script type="text/javascript" src="../../js/dal/base.js"></script>
		<script type="text/javascript" src="../../js/dal/user.js"></script>

		<script type="text/javascript" src="../../js/app/app.js"></script>
		<script type="text/javascript" src="../../js/app/app-rules.js"></script>
		<script type="text/javascript" src="../../js/app/app-page.js"></script>

		<script type="text/javascript" src="../../js/lib/Rx.min.js"></script>

		<script type="text/javascript">
			mui.init()

			new Vue({
				el: ".mui-content",
				data: function() {
					return {
						username: '',
						verifycode: '',
						loading: false,
						user_agree: false, // 用户协议
						codeState: false,
						codeTimer: 60,
						codeT: null,
						codeNumber: "", // 验证码
					};
				},

				mounted: function() {
					function GetQueryString(name) {
						var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
						var r = window.location.search.substr(1).match(reg);
						if(r != null) return unescape(r[2]);
						return null;
					}
					// 拿到上个页面填入的帐号
					var tel = GetQueryString('tel');
					this.username = tel;
				},

				methods: {
					getCodeTap: function() {
						var that = this;

						// 本地验证手机号码
						var $localCheckTelFn = function(telphone) {
							return Rx.Observable.create(function(ob) {
								var errorMessage = app.rules.test("tel", telphone, "手机号码格式不正确");
								if(errorMessage) {
									return ob.error({
										message: errorMessage
									})
								}
								ob.next(telphone);
							});
						}

						// 发送获取验证码的请求
						var $getCodeFn = function(telphone) {
							return Rx.Observable.create(function(ob) {
								dal.user.getCode(telphone, function(err, data) {
									if(err) {
										return ob.error(err);
									}

									ob.next(data.validcode);
								});
							});
						}

						// 验证码按钮变化
						var $codeTimer = Rx.Observable
							.interval(1000)
							.take(60);

						// 显示waiting
						plus.nativeUI.showWaiting();
						// 验证手机是否符合规格
						$localCheckTelFn(that.username)
							// 获取短信验证码
							.mergeMap($getCodeFn)
							// 获取成功
							.subscribe(function(code) {
								// 关闭waiting 且 提示用户
								plus.nativeUI.closeWaiting();
								mui.toast("发送短信验证码成功，请注意查收");
								that.codeNumber = code;
								that.codeState = true;
								// 开始计时
								$codeTimer.subscribe(function(t) {
									if(t >= 59) {
										that.codeState = false;
										that.codeTimer = 60;
									}
									that.codeTimer--;
								});

							}, function(e) {
								// 错误回调

								plus.nativeUI.closeWaiting();
								mui.toast(e.message);
							});

					},
					onLoginTap: function(e) {
						if(this.loading) {
							return;
						}

						var that = this;

						//this.loading = true;
						if(this.username.trim().length === 0) {
							return mui.toast('手机号不能为空');
						}

						if(this.codeNumber.trim().length === 0) {
							return mui.toast('验证码不能为空');
						}

						var errorMessage = app.rules.test("tel", this.username, "手机号码格式不正确");
						if(errorMessage) {
							return mui.toast(errorMessage);
						}

						// 验证验证码
						if(this.verifycode !== this.codeNumber) {
							//this.loading = false;
							return mui.toast('短信验证码不正确');
						}

						app.page.openForResultBy('reset2.html', 'reset2', function(data) {
							if(data.result) {
								mui.back();
								//app.page.setResult({}).close();
							}
						}, {
							account: this.username
						});

					}
				},
				watch: {
					loading: function(newVal, oldVal) {
						mui('#loginBtn').button(newVal ? "loading" : "reset");
					},
					username: function() {
						this.codeNumber = "";
					}
				}

			});
		</script>
	</body>

</html>