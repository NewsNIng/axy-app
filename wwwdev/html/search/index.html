<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="../../js/common/flexible.js"></script>
		<link href="../../css/lib/mui.min.css" rel="stylesheet" />

		<link rel="stylesheet" href="../../css/app/app.css" />
		<style type="text/css">
			html,
			body,
			.mui-content {
				background-color: #FFFFFF !important;
			}
			/*搜索框头部*/
			
			.mui-bar {
				padding: 0 0 0 0.346666rem;
			}
			
			.app-input-room input::-webkit-input-placeholder {
				font-size: 12px !important;
				color: #9F9FA0 !important;
			}
			
			[data-dpr="2"] .app-input-room input::-webkit-input-placeholder {
				font-size: 24px !important;
			}
			
			[data-dpr="3"] .app-input-room input::-webkit-input-placeholder {
				font-size: 36px !important;
			}
			
			.app-input-room {
				width: 8.5rem;
				position: relative !important;
			}
			
			.app-input-room>span.mui-icon {
				position: absolute;
				left: 10px;
				top: 0;
			}
			
			.app-input-room>span.mui-icon.close {
				/*display: none;*/
				left: initial;
				right: 10px;
			}
			/*.app-input-room.active>span.mui-icon.close {
				display: block;
			}*/
			
			.app-input-room img {
				width: 16px;
			}
			
			.app-input-room input {
				width: 100%;
				padding-left: .8rem !important;
				text-align: left !important;
				border-radius: 50px !important;
				background-color: #FFFFFF !important;
			}
			/*end搜索框头部*/
			/*搜索历史*/
			
			div.history,
			div.hot {
				padding: 0.32rem 0.246666rem 0.5rem 0.246666rem;
				position: relative;
				height: auto;
			}
			
			div.history:after,
			div.hot:after {
				content: '';
				height: 10px;
				background-color: #F4F8FB;
				display: block;
				position: absolute;
				bottom: -10px;
				left: 0;
				width: 100%;
				margin-bottom: 10px;
			}
			
			.tips {
				margin: 0 0 8px .1rem;
			}
			
			.tips .mui-pull-right {
				padding-left: 5px;
			}
			
			.tips img {
				width: 0.4rem;
			}
			
			.cardRoom {
				display: flex;
				display: -webkit-flex;
				align-content: center;
				justify-content: flex-start;
				flex-flow: wrap row;
				color: #888888;
			}
			
			.cardRoom>div:active {
				background-color: #F4F8FB;
			}
			
			.cardRoom>div {
				text-align: center;
				display: inline-block;
				height: 0.773333rem;
				line-height: 0.773333rem !important;
				padding: 0 0.25rem;
				margin: 0.1rem;
				border-radius: 3px;
				background-color: #e5e6e7;
			}
			/*end搜索历史*/
			/*think*/
			
			.think ul:before {
				height: 0 !important;
			}
			
			.think ul:after {
				height: 0 !important;
			}
			
			.think ul .mui-badge {
				font-size: inherit;
				color: #9F9FA0;
				background-color: transparent !important;
				padding: 0 !important;
			}
			
			.mui-table-view-cell:after {
				left: 0.36rem;
				right: 0.36rem;
				background-color: #E5E6E7;
			}
			/*搜索结果*/
			
			body>.mui-progressbar {
				top: 0;
				/*background-color: rgba(255,255,255,0.4);*/
				background-color: #FFFFFF !important;
			}
			
			body>.mui-progressbar:before,
			body>.mui-progressbar>span {
				/*background-color: rgba(255,255,255,0.22) !important;*/
				background-color: #06C1AE !important;
			}
			/*tab*/
			
			.tabroom {
				background-color: #FFFFFF;
				width: 100%;
				height: 1.066666rem;
				/*height: 1.386666rem;*/
				text-align: center;
				border-bottom: 1px solid #EFEFF4;
			}
			
			.tabroom>div {
				text-align: center;
				padding: 0;
				margin: 0 .38rem;
				font-weight: bold;
				display: inline-block;
				/*line-height: 1.386666rem;*/
				letter-spacing: .01rem;
				line-height: 1.066666rem;
				color: #a8a8a8;
				position: relative;
			}
			
			.tabroom>div.app-color-main:before {
				content: "";
				width: 90%;
				height: 0.053333rem;
				background-color: #2BB8AA;
				display: block;
				position: absolute;
				left: 5%;
				border-radius: .1rem;
				/*bottom: 0.293333rem;*/
				bottom: 0.2rem;
			}
			
			.wrapper {
				overflow: hidden;
				height: 100%;
			}
			
			.wrapper ul {
				padding: 0;
				margin: 0;
			}
			
			.wrapper li {
				list-style: none;
				padding: 0.546666rem 0.346666rem;
				position: relative;
			}
			
			.wrapper li:after {
				content: '';
				position: absolute;
				left: 0;
				bottom: 0;
				width: 100%;
				height: 1px;
				background-color: #F4F8FB;
				transform: scaleY(0.5);
				-webkit-transform: scaleY(0.5);
			}
			
			.wrapper li .imgdiv,
			.wrapper li .textdiv {
				width: 2.453333rem;
				height: 2.453333rem;
				display: inline-block;
			}
			
			.wrapper li .imgdiv {
				/*background-image: url(bg@2x.png);*/
				background-repeat: no-repeat;
				background-size: cover;
				background-position: center;
			}
			
			.wrapper li .textdiv {
				margin-left: 0.346666rem;
				width: 6.4rem;
				overflow: hidden;
				position: relative;
				float: right;
			}
			
			.wrapper li .textdiv .tips {
				text-align: right;
				position: absolute;
				bottom: 0;
				right: 0;
				width: 100%;
				margin: 0;
			}
			
			.wrapper ul {
				padding-bottom: 1rem;
			}
			
			.mui-ellipsis-2 {
				margin-top: 0.133333rem;
			}
			
			.null {
				text-align: center;
			}
			
			.null img {
				width: 4rem;
				height: 4rem;
				margin-top: 2rem;
			}
			/*end搜索结果*/
		</style>
	</head>

	<body>

		<div id="warpper">

			<header class="mui-bar mui-bar-nav app-header">
				<div class="app-input-room mui-pull-left" :class="active&&'active'">
					<span class="mui-icon">
						<img src="../../image/search/search@3x.png"/>
					</span>
					<form onsubmit="return onSubmit()">
						<input ref="input" v-model="content" @blur="active=false" @focus="active=true" class="app-font-size-24" type="search" placeholder="你想要的吃喝玩乐">
					</form>
					<span class="mui-icon close" v-show="content.length" @touchstart="onClearTap()">
						<img src="../../image/search/clear@3x.png"/>
					</span>
				</div>
				<div @tap="onCancelTap()" style="color: #FFFFFF; line-height: 44px; text-align: center;width: 1rem; " class="mui-pull-left app-font-size-24 mui-action-back">取消</div>
			</header>

			<div class="mui-content app-font-size-28">
				<!--搜索历史-->
				<div class="history" v-show="searchState === 0 && historyList.length">
					<div class="tips app-font-size-24 app-color-dark">
						<span>搜索历史</span>
						<span class="mui-icon mui-pull-right" @tap="onClearHis()">
							<img src="../../image/search/del@3x.png"/>
						</span>
					</div>

					<div class="cardRoom app-font-size-26">
						<template v-for="o,i in historyList">
							<div @tap="searchResult(o)" class="mui-ellipsis">{{o}}</div>
						</template>
					</div>
				</div>
				<!--热门搜索-->
				<div class="hot" v-show="searchState === 0">
					<div class="tips app-font-size-24 app-color-dark">热门搜索</div>
					<div class="cardRoom app-font-size-26">
						<template v-for="o,i in hotList">
							<div @tap="searchResult(o.keyword)">{{o.keyword}}</div>
						</template>
					</div>
				</div>

				<!--联想搜索词-->
				<div class="think app-font-size-2d8" v-show="searchState === 1">

					<ul class="mui-table-view">
						<template v-show="content.trim().length">
							<li class="mui-table-view-cell" @tap="searchResult()">
								<a class="">
									<span>搜索 “{{content}}”</span>
								</a>
							</li>
						</template>
						<template v-for="o,i in thinkList">
							<li class="mui-table-view-cell" @tap="onRsTap(o)">
								<a class="">
									<span>{{o.keyword}}</span>
									<!--<span class="mui-badge">{{o.count}}{{_2Type(o.type)}}</span>-->
								</a>
							</li>
						</template>
					</ul>
				</div>

				<!--搜索结果页面-->
				<div v-show="searchState === 2" class="result">
					<!--进度条-->
					<!--<div ref="progressbar" v-if="searchIng" class="mui-progressbar mui-progressbar-infinite">
						<span></span>
					</div>-->
					<!--结果页面-->
					<div class="tabroom" ref='tabroom'>
						<template v-for="o, i in tab.items">
							<div class="app-font-size-30" :class="{'app-color-main': tab.active === i}" @tap="onTabTap(o, i)">
								{{o.name}}
							</div>
						</template>
					</div>
					<!--列表-->
					<div class="rsroom">

						<div class="wrapper" ref="wrapper">
							<!--如果有数据则显示-->
							<ul v-show="resultList.length">
								<template v-for="o,i in resultList">
									<li @tap="onItemTap(o)">
										<div class="imgdiv img-lazy-load img-lazy-forever" :data-src="_getImg(o.image1,o.image2,o.image3)">

										</div>
										<div class="textdiv app-font-size-28">
											<div class="app-color-333333 mui-ellipsis">
												{{o.name || o.title || ""}}
											</div>
											<div class="app-color-9f9fa0 mui-ellipsis-2">
												{{o.address || o.content || ""}}
											</div>
											<div class="app-color-9f9fa0 tips mui-ellipsis">
												<span v-if="o.distance">
													距离您的位置  {{_m2km(o.distance)}}
												</span>
												<span v-else>
													{{o.likecount}}人表示很喜欢
												</span>
											</div>
										</div>
									</li>
								</template>

							</ul>
							<!--无数据且搜索完毕-->
							<template v-if="!searchIng && resultList.length === 0">
								<div class="null">
									<img src="../../image/search/background@3x.png" />
									<div class="app-color-9f9fa0">
										搜索内容结果为空
									</div>
								</div>
							</template>

						</div>

					</div>
				</div>

			</div>

		</div>
		<script src="../../js/common/immersed.js"></script>
		<script src="../../js/lib/mui.min.js"></script>
		<script type="text/javascript" src="../../js/lib/vue.min.js"></script>
		<script type="text/javascript" src="../../js/lib/vue-ni.js"></script>
		<script src="../../js/lib/better-scroll.min.js"></script>

		<script type="text/javascript" src="../../js/dal/base.js"></script>
		<script type="text/javascript" src="../../js/dal/search.js"></script>
		<script type="text/javascript" src="../../js/lib/md5.min.js"></script>
		<script type="text/javascript" src="../../js/common/imagelazyload.js"></script>

		<script type="text/javascript">
			function onSubmit() {
				return false;
			}

			mui.init();
			// 搜索历史缓存
			var historyList = new ni.Cache("search_history_list", ['智能主机'], {
				max: 10
			});

			new Vue({
				el: '#warpper',
				data: function() {
					return {
						n: 1,
						maxScrollY: 200,

						longitude: 0,
						latitude: 0,
						city: '深圳',

						active: false,
						content: '',
						thinkList: [],
						//						resultList: [],
						searchIng: false,
						resultOver: false,
						historyList: historyList.data,
						hotList: [],
						progressbar: null,
						tab: {
							active: 0,
							items: [{
									name: "全部",
									id: 'nearby_pages_list',
									url: './pages/list.html'
								},
								{
									name: "商家",
									id: 'theme',
									url: './pages/theme.html'
								},
								{
									name: "内容",
									id: 'discover',
									url: './pages/discover.html'
								}
							]
						},

						articleList: [],
						storeList: [],
					};
				},
				computed: {
					// 当前页面状态
					searchState: function() {
						// 是否焦点
						if(this.active) {
							if(this.content.trim().length) {
								return 1;
							} else {
								return 0;
							}
						} else {
							if(this.resultOver || this.searchIng) {
								return 2;
							} else {
								return 0;
							}
						}

					},
					resultList: function() {
						return [this.allList, this.storeList, this.articleList][this.tab.active];
					},
					allList: function() {
						var l1 = this.articleList.length,
							l2 = this.storeList.length;
						var i1 = 0,
							i2 = 0;
						var arr = [];
						var b = true;
						while(i1 < l1 && i2 < l2) {
							if(b) {
								arr.push(this.articleList[i1]);
								i1++;
							} else {
								arr.push(this.storeList[i2]);
								i2++;
							}
							b = !b;
						}
						if(i1 >= l1) {
							arr.push.apply(arr, this.storeList.slice(i2));
						} else {
							arr.push.apply(arr, this.articleList.slice(i1));
						}

						return arr;
						// 以上代码是 两个队列每次各塞一个，循环下来多余的补齐尾部

						// 以下代码是 以前的随机排序   放弃
						var arr = this.articleList.concat(this.storeList).sort(function() {
							var _ = 1;
							return function() {
								return _ * -1;
							}
						}());
						return arr;
					}
				},
				watch: {
					// 监听 搜索 值
					content: function(nv) {
						this.resultOver = false;
						var c = function() {
							window.clearTimeout(this._thinkT);
							this._thinkT = null;
						}
						// 节流处理
						this._thinkT && c();
						this._thinkT = setTimeout(function() {
							// 提交搜索请求
							this.n = 1;
							this.thinkResult();
							c();
						}.bind(this), 500);
					},
					searchIng: function(nv) {
						this.progressbar && this.progressbar[nv ? 'show' : 'hide']();
					}
				},
				mounted: function() {
					this.progressbar = mui('body').progressbar();

					var wrapper = this.$refs.wrapper;
					var wrapperHight = (document.documentElement.clientHeight || document.body.clientHeigth) -
						this.$refs.tabroom.offsetHeight -
						immersed -
						44;

					wrapper.style.height = wrapperHight + 'px';

					this.$nextTick(function() {
						if(!this.scroll) {
							this.scroll = new BScroll(wrapper, {
								click: true,
								scrollY: true,
								pullUpLoad: {
									threshold: -70, // 负值是当上拉到超过低部 70px；正值是距离底部距离 时，                    
								}
							});
							this.scroll.on('pullingUp', function() {
								// 获取更多 TODO
								this.n++;
								this.searchResult();

							}.bind(this));

						} else {
							this.scroll.refresh();
						}

					}.bind(this));

					document.addEventListener('keypress', function(e) {
						e.keyCode === 13 && this.searchResult();
					}.bind(this));

					// 获取热门搜索词
					this.hotResult();
				},
				plusReady: function() {
					// 自动打开软键盘 

					if(ni.os.android) {
						//this.softinput = new ni.android.SoftInput();
					} else {
						this.softinput = new ni.ios.SoftInput();
					}
					setTimeout(function() {
						this.softinput && this.softinput.show(this.$refs.input);
					}.bind(this))

					var city = this.$view.city;
					var latitude = this.$view.latitude;
					var longitude = this.$view.longitude;

					if(city && latitude && longitude) {
						this.longitude = longitude;
						this.latitude = latitude;
						this.city = city;
					} else {
						// 获取定位信息
						plus.geolocation.getCurrentPosition(function(p) {
							this.longitude = p.coords.longitude;
							this.latitude = p.coords.latitude;
							this.city = p.address.city.replace('市', '');
							// this.position = p.address.poiName;
						}.bind(this));
					}

				},
				methods: {
					// 点击删除历史记录
					onClearHis: function() {
						var that = this;
						new Promise(function(resolve, reject) {
								// 提示用户是否删除
								mui.confirm("是否清除历史记录", "", ["清除", "取消"], function(e) {
									if(!e.index) {
										resolve();
									}
								});
							})
							.then(function() {
								// 清除页面历史记录数据
								that.historyList = [];
								// 清楚本地缓存数据
								historyList.data = [];
							});

					},
					// 点击取消文字时
					onCancelTap: function() {
						// 页面返回
						this.softinput && ni.os.android && this.softinput.hide();
					},
					// 点击清除图标时
					onClearTap: function() {
						// 清空输入值
						this.content = '';
						this.thinkList = [];
						this.articleList = [];
						this.storeList = [];
						this.tab.active = 0;
					},
					// 获取热门搜索词
					hotResult: function() {
						dal.search.hotkeyword(function(err, data) {
							if(err) {
								return
							}
							this.hotList = data;
						}.bind(this));
					},
					// 获取联想内容
					thinkResult: function() {
						dal.search.tipkeyword(this.content, function(err, data) {
							if(err) {
								return
							}
							this.thinkList = data;
						}.bind(this));
					},
					// 搜索内容条目被点击时
					onRsTap: function(o) {
						this.searchResult(o.keyword);
					},
					// 搜索结果列表被点击时
					onItemTap: function(o) {
						if(o.senddate) {
							// 说说
							mui.openWindow('../nearby/discover/discover_details.html', 'discover_details', {
								extras: {
									oid: o.id
								}
							});
						} else {
							// 店铺
							mui.openWindow('../nearby/business/store_details.html', 'store_details', {
								extras: {
									oid: o.id
								}
							});
						}
					},
					// 获取搜索内容
					searchResult: function(s) {
						this.$refs.input.blur();
						// 搜索中
						this.searchIng = true;
						this.content = s || this.content;
						if(!this.content || this.content.toString().trim().length === 0) {
							this.searchIng = false;
							this.$refs.input.focus();
							return mui.toast("输入错误请重新编辑内容");
						}
						// 保存搜索历史
						this.saveHistory();
						// 发送请求

						dal.search.list(this.longitude, this.latitude, this.city, this.content, this.n, function(err, data) {
							// 搜索完毕
							this.searchIng = false;
							this.resultOver = true;

							if(err) {
								return mui.toast(err.message);
							}

							var article = data.article || [];
							var store = data.store || [];
							if(this.n > 1) {
								article.length && this.articleList.push.apply(this.articleList, article);
								store.length && this.storeList.push.apply(this.storeList, store);
							} else {
								this.articleList = article;
								this.storeList = store;
							}

							this.$nextTick(function() {
								this.scroll && (this.scroll.finishPullUp(), this.scroll.refresh());
								imagelazyload();
							}.bind(this));
						}.bind(this));

					},
					saveHistory: function() {
						if(this.historyList.indexOf(this.content) < 0) {
							historyList.unshift(this.content);
							this.historyList = historyList.data;
						}

					},
					onTabTap: function(o, i) {
						if(this.tab.active === i) {
							return;
						}
						this.tab.active = i;
						this.$nextTick(function() {
							imagelazyload();
						});
					},
					_getImg: function(img1, img2, img3) {
						return img1 || img2 || img3;
					},
					_m2km: function(m) {
						if(m < 1000) {
							return m + ' m';
						}
						return(m / 1000).toFixed(1) + " km";
					},
				}
			});
		</script>
	</body>

</html>